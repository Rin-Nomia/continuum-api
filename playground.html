<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Continuum ‚Äî Risk Governance Demo</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#0a0a0a;
      color:#e6e6e6;
      padding:20px;
      line-height:1.55;
    }
    .container{ max-width:980px; margin:0 auto; }
    header{ text-align:left; margin-bottom:18px; }
    .brand{ display:flex; align-items:baseline; gap:10px; }
    .brand h1{ font-size:1.6em; color:#fff; letter-spacing:0.2px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid #2a2a2a; color:#bdbdbd; font-size:0.85em;
      background:#111;
    }
    .hero{
      margin-top:12px;
      background:linear-gradient(180deg,#111,#0a0a0a);
      border:1px solid #222;
      border-radius:10px;
      padding:16px;
    }
    .hero .headline{ font-size:1.15em; color:#fff; margin-bottom:6px; }
    .hero .sub{ color:#a8a8a8; font-size:0.92em; }
    .hero .sub strong{ color:#d9d9d9; font-weight:700; }
    .hero .micro{
      margin-top:10px;
      color:#bdbdbd;
      font-size:0.9em;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .legend{
      display:inline-flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #222;
      background:#0d0d0d;
    }
    .lamp{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800;
      letter-spacing:.2px;
      font-size:0.92em;
      white-space:nowrap;
    }
    .lamp .c{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .c-g{ background:#51cf66; }
    .c-y{ background:#ffd43b; }
    .c-r{ background:#ff6b6b; }

    .panel{
      background:#111;
      border:1px solid #2b2b2b;
      border-radius:10px;
      padding:16px;
      margin-top:14px;
    }
    .panel-title{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .panel-title .left{
      display:flex; flex-direction:column; gap:2px;
    }
    .panel-title .kicker{
      font-size:0.78em;
      color:#9a9a9a;
      letter-spacing:0.7px;
      text-transform:uppercase;
    }
    .panel-title .name{
      font-size:1.05em; color:#fff;
    }
    .panel-title .hint{
      color:#8d8d8d; font-size:0.85em;
    }

    textarea{
      width:100%;
      min-height:120px;
      background:#0a0a0a;
      border:1px solid #2b2b2b;
      border-radius:8px;
      padding:12px;
      color:#e6e6e6;
      font-size:1em;
      resize:vertical;
      font-family:inherit;
    }
    textarea:focus{ outline:none; border-color:#4a9eff; }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center;
    }
    .btn{
      border:none; border-radius:8px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      transition:transform 0.05s ease, opacity 0.2s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:#4a9eff; color:#fff; }
    .btn-primary:disabled{ opacity:0.5; cursor:not-allowed; }
    .btn-ghost{
      background:#1b1b1b; color:#e6e6e6; border:1px solid #2b2b2b;
      font-weight:700;
    }
    .btn-ghost:hover{ border-color:#3a3a3a; }

    .meta{
      margin-left:auto;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .counter{ color:#8d8d8d; font-size:0.9em; }
    .counter.good{ color:#51cf66; }
    .counter.warn{ color:#ff922b; }

    .compare{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 860px){
      .compare{ grid-template-columns:1fr; }
    }

    .card{
      border-radius:10px;
      padding:16px;
      border:1px solid #2b2b2b;
      background:#111;
      min-height:170px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card-head .title{
      font-size:1em; color:#fff;
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap;
      font-weight:900;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.85em;
      font-weight:900;
      letter-spacing:0.2px;
      white-space:nowrap;
      border:1px solid transparent;
    }
    .badge-risk{ background:#2b1515; color:#ff6b6b; border:1px solid #ff6b6b33; }
    .badge-safe{ background:#132215; color:#51cf66; border:1px solid #51cf6633; }
    .badge-info{ background:#1a2332; color:#88b3ff; border:1px solid #88b3ff33; }
    .badge-warn{ background:#2a210f; color:#ffd43b; border:1px solid #ffd43b33; }
    .badge-audit{ background:#0f0f0f; color:#cfcfcf; border:1px solid #2b2b2b; font-weight:800; }
    .badge-pass{ background:#132215; color:#51cf66; border:1px solid #51cf6633; font-weight:900; }
    .badge-block{ background:#2b1515; color:#ff6b6b; border:1px solid #ff6b6b33; font-weight:900; }

    .blurb{
      color:#a8a8a8;
      font-size:0.92em;
    }
    .blurb strong{ color:#e6e6e6; }

    .box{
      background:#0a0a0a;
      border:1px solid #2b2b2b;
      border-radius:10px;
      padding:12px;
      color:#e6e6e6;
      font-size:1em;
      min-height:64px;
      white-space:pre-wrap;
    }

    .divider{
      height:1px;
      background:#222;
      margin:12px 0;
    }

    .mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:#9a9a9a; font-size:0.9em;
    }

    .tone-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #2b2b2b;
      background:#0f0f0f;
      color:#cfcfcf;
      font-weight:800;
      font-size:0.88em;
    }
    .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
    .dot-anx{ background:#ff6b6b; }
    .dot-sharp{ background:#ff922b; }
    .dot-cold{ background:#4dabf7; }
    .dot-blur{ background:#868e96; }
    .dot-pushy{ background:#f783ac; }
    .dot-unk{ background:#444; }

    .note{
      background:#101827;
      border:1px solid #23344f;
      border-radius:10px;
      padding:12px;
      color:#9ec3ff;
      font-size:0.9em;
      display:none;
    }

    .audit-note{
      background:#0f1218;
      border:1px solid #262c38;
      border-radius:10px;
      padding:12px;
      color:#b9c0cc;
      font-size:0.9em;
      display:none;
    }
    .audit-note strong{ color:#e6e6e6; }

    .error{
      background:#2d1f1f;
      border:1px solid #ff6b6b;
      border-radius:10px;
      padding:12px;
      color:#ff6b6b;
      margin-top:12px;
      font-size:0.92em;
      display:none;
    }

    /* Dashboard */
    .metrics{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:14px;
      margin-top:14px;
    }
    .metric{
      border-radius:10px;
      padding:16px;
      border:1px solid #2b2b2b;
      background:#111;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:160px;
    }
    .metric .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
      font-weight:900;
      color:#fff;
    }
    .metric .value{
      background:#0a0a0a;
      border:1px solid #2b2b2b;
      border-radius:8px;
      padding:12px;
      white-space:pre-wrap;
      font-family:inherit;
      color:#e6e6e6;
    }
    .metric .help{
      color:#a8a8a8;
      font-size:0.92em;
    }
    .metric .help strong{ color:#e6e6e6; }

    footer{
      margin-top:18px;
      border-top:1px solid #222;
      padding-top:14px;
      color:#8d8d8d;
      font-size:0.85em;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    footer a{ color:#4a9eff; text-decoration:none; }
  </style>
</head>

<body>
<div class="container">
  <header>
    <div class="brand">
      <h1>üíé Continuum</h1>
      <span class="pill">AI Conversation Risk Governance</span>
    </div>

    <div class="hero">
      <div class="headline">
        Continuum is the <strong>circuit breaker</strong> for generative AI ‚Äî deciding when the model should
        <strong>speak</strong>, <strong>soften</strong>, or <strong>stay silent</strong>.
      </div>
      <div class="sub">
        One decision per output. <strong>Auditable.</strong> <strong>No retraining.</strong>
      </div>

      <div class="micro">
        <div class="legend" aria-label="Decision states">
          <span class="lamp"><span class="c c-g"></span>ALLOW</span>
          <span style="opacity:.5;">‚Ä¢</span>
          <span class="lamp"><span class="c c-y"></span>GUIDE</span>
          <span style="opacity:.5;">‚Ä¢</span>
          <span class="lamp"><span class="c c-r"></span>BLOCK</span>
        </div>
        <div style="opacity:.85;">Even when the text looks the same, the decision behind it is the product.</div>
      </div>
    </div>
  </header>

  <!-- Layer 1 -->
  <section class="panel">
    <div class="panel-title">
      <div class="left">
        <div class="kicker">Layer 1</div>
        <div class="name">User Input</div>
      </div>
      <div class="hint">Start with a complete sentence (15+ chars recommended)</div>
    </div>

    <textarea id="inputText" placeholder="Type a user message‚Ä¶ (15+ characters recommended)"></textarea>

    <div class="row">
      <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeText()">Run Demo</button>

      <!-- Example buttons (the ‚Äúold full version‚Äù feeling) -->
      <button class="btn btn-ghost" type="button" onclick="loadExample('anx')">Anxious</button>
      <button class="btn btn-ghost" type="button" onclick="loadExample('sharp')">Sharp</button>
      <button class="btn btn-ghost" type="button" onclick="loadExample('cold')">Cold</button>
      <button class="btn btn-ghost" type="button" onclick="loadExample('blur')">Blur</button>

      <div class="meta">
        <div id="charCounter" class="counter">0 chars</div>
      </div>
    </div>

    <div id="errorMsg" class="error"></div>
  </section>

  <!-- Layer 2 / 3 Compare -->
  <section class="compare">
    <!-- Layer 2: Raw AI (Ungoverned) -->
    <div class="card" style="border-color:#3a1f1f;">
      <div class="card-head">
        <div class="title">
          <span style="opacity:.9;">Layer 2</span>
          <span>Raw AI Output (Ungoverned)</span>
        </div>
        <span class="badge badge-risk" id="baselineBadge">RISK</span>
      </div>

      <div class="blurb">
        <strong>Why users leave:</strong> the model adds an extra step (comfort / explain / advise) when the user didn‚Äôt allow it.
      </div>

      <div class="box" id="baselineText">(Run demo to generate a typical risky response)</div>

      <div class="mini" id="baselineWhy">
        <span class="badge badge-warn">overreach</span>
        <span>Common failure: the AI ‚Äúdoes more‚Äù than the user allowed.</span>
      </div>
    </div>

    <!-- Layer 3: Continuum Decision Output -->
    <div class="card" style="border-color:#1f3a25;">
      <div class="card-head">
        <div class="title">
          <span style="opacity:.9;">Layer 3</span>
          <span>Continuum Decision Output</span>
        </div>
        <span class="badge badge-safe" id="govBadge">ALLOW</span>
      </div>

      <div class="blurb" id="govBlurb">
        <strong>CIP Decision:</strong> every output receives exactly one state ‚Äî <strong>ALLOW</strong>, <strong>GUIDE</strong>, or <strong>BLOCK</strong>.
      </div>

      <div class="box" id="govText">(Waiting‚Ä¶)</div>

      <div class="divider"></div>

      <div class="mini">
        <span id="toneTag" class="tone-tag"><span class="dot dot-unk"></span><span>tone: Unknown</span></span>
        <span class="badge badge-info" id="modeTag">decision: -</span>
        <span class="badge badge-info" id="confTag">confidence: -</span>
      </div>

      <div class="mini" style="margin-top:6px;">
        <span class="badge badge-info" id="decisionLog">CIP Decision: -</span>
        <span class="badge badge-info" id="cipTag">CIP: -</span>
      </div>

      <!-- Audit (real if API provides; otherwise minimal) -->
      <div class="mini" style="margin-top:6px;">
        <span class="badge badge-audit" id="auditSource">source: -</span>
        <span class="badge badge-audit" id="auditLLM">llm: -</span>
        <span class="badge badge-audit" id="auditGate">gate: -</span>
        <span class="badge badge-audit" id="auditLatency">latency: -</span>
      </div>

      <!-- Decision Log Panel -->
      <div id="auditNote" class="audit-note"></div>
      <div id="govNote" class="note"></div>
    </div>
  </section>

  <!-- Governance Dashboard (3 must-have metrics) -->
  <section class="panel" style="margin-top:16px;">
    <div class="panel-title">
      <div class="left">
        <div class="kicker">Dashboard</div>
        <div class="name">Governance Metrics</div>
      </div>
      <div class="hint">Value is measured in prevented failures, not visible edits</div>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="title">
          <span>üü¢ Decision Distribution</span>
          <span class="badge badge-safe">Always On</span>
        </div>
        <div class="help">
          <strong>Most outputs pass unchanged.</strong> Interventions happen only when risk is detected.
        </div>
        <div class="value" id="mDecisionDist">ALLOW: -%&#10;GUIDE: -%&#10;BLOCK: -%</div>
      </div>

      <div class="metric">
        <div class="title">
          <span>üü° Overreach Prevented</span>
          <span class="badge badge-warn">Visible</span>
        </div>
        <div class="help">
          <strong>This is what users never had to endure.</strong> ‚ÄúExtra help‚Äù suppressed.
        </div>
        <div class="value" id="mImpact">Suppressed responses: -&#10;Suppressed chars (avg): -</div>
      </div>

      <div class="metric">
        <div class="title">
          <span>üîµ Governance Cost</span>
          <span class="badge badge-info">Low</span>
        </div>
        <div class="help">
          <strong>Safety without slowing anything down.</strong> No prompt rewrites required.
        </div>
        <div class="value" id="mCost">Avg latency: - ms&#10;Prompt changes required: 0</div>
      </div>
    </div>
  </section>

  <footer>
    <div>
      <strong>Continuum</strong> ‚Äî Output-side risk governance layer (non-invasive)
    </div>
    <div>
      API Docs:
      <a href="https://rinnomia-continuum-api.hf.space/docs" target="_blank">rinnomia-continuum-api.hf.space</a>
    </div>
  </footer>
</div>

<script>
  const API_URL = 'https://rinnomia-continuum-api.hf.space/api/v1/analyze';

  const examples = {
    anx: "ÊàëÁúüÁöÑ‰∏çÁü•ÈÅìË©≤ÊÄéÈ∫ºËæ¶‰∫ÜÔºåÊàëË¶∫ÂæóÊàëÊíê‰∏ç‰Ωè„ÄÇ",
    sharp: "‰∏çË¶ÅÂÜçÂïè‰∫ÜÔºåÁõ¥Êé•Áµ¶ÊàëÁ≠îÊ°à„ÄÇ",
    cold: "Â•Ω„ÄÇ",
    blur: "Êàë‰πü‰∏çÁü•ÈÅìÊ¨∏ÔºåÂèØËÉΩÂêß„ÄÇ"
  };

  // Session-level dashboard stats (works even if API doesn't provide metrics)
  const sessionStats = {
    total: 0,
    allow: 0,
    guide: 0,
    block: 0,
    suppressedResponses: 0,
    suppressedCharsTotal: 0,
    latencyTotalMs: 0
  };

  function loadExample(key){
    const el = document.getElementById('inputText');
    el.value = examples[key] || "";
    updateCounter();
  }

  const inputEl = document.getElementById('inputText');
  inputEl.addEventListener('input', updateCounter);

  function updateCounter(){
    const count = inputEl.value.trim().length;
    const counter = document.getElementById('charCounter');
    counter.textContent = `${count} chars`;
    counter.className = 'counter ' + (count < 15 ? 'warn' : 'good');
  }

  function showError(msg){
    const box = document.getElementById('errorMsg');
    box.style.display = 'block';
    box.textContent = msg;
  }
  function clearError(){
    const box = document.getElementById('errorMsg');
    box.style.display = 'none';
    box.textContent = '';
  }

  function setAuditDefaults(){
    document.getElementById('auditSource').textContent = 'source: -';
    document.getElementById('auditLLM').textContent = 'llm: -';
    document.getElementById('auditGate').textContent = 'gate: -';
    document.getElementById('auditLatency').textContent = 'latency: -';

    document.getElementById('auditSource').className = 'badge badge-audit';
    document.getElementById('auditLLM').className = 'badge badge-audit';
    document.getElementById('auditGate').className = 'badge badge-audit';
    document.getElementById('auditLatency').className = 'badge badge-audit';

    const note = document.getElementById('auditNote');
    note.style.display = 'none';
    note.textContent = '';

    const govNote = document.getElementById('govNote');
    govNote.style.display = 'none';
    govNote.textContent = '';

    const decisionLog = document.getElementById('decisionLog');
    decisionLog.textContent = 'CIP Decision: -';
    decisionLog.className = 'badge badge-info';

    const cipTag = document.getElementById('cipTag');
    cipTag.textContent = 'CIP: -';
    cipTag.className = 'badge badge-info';
  }

  function humanizeDecision(decisionLower){
    const d = String(decisionLower || '').toLowerCase();
    if (d === 'allow' || d === 'no-op' || d === 'noop') return 'allow';
    if (d === 'guide') return 'guide';
    if (d === 'block') return 'block';
    if (d === 'repair') return 'guide';
    if (d === 'suggest') return 'guide';
    return d || 'allow';
  }

  // Anti-confusion rule:
  // If displayed output equals user input, it is GUIDE via Echoing Protocol, not ALLOW.
  function resolveDecision(decision, userText, outputText){
    const d = humanizeDecision(decision);
    const u = String(userText || '').trim();
    const o = String(outputText || '').trim();
    if (d === 'allow' && u && o && u === o) return 'guide';
    return d;
  }

  function decisionBadgeUI(decision){
    const d = humanizeDecision(decision);
    if (d === 'allow') return {
      text: 'ALLOW',
      cls: 'badge badge-safe',
      blurb: "<strong>CIP Decision:</strong> <strong>ALLOW</strong> ‚Äî context is stable. Output approved unchanged (no intervention).",
      log: "CIP Decision: ALLOW ‚Äî transparent pass-through.",
      cip: { text: "CIP: Context Integrity Preserved", cls: "badge badge-info" }
    };
    if (d === 'guide') return {
      text: 'GUIDE',
      cls: 'badge badge-warn',
      blurb: "<strong>CIP Decision:</strong> <strong>GUIDE</strong> ‚Äî sensitivity detected. Echoing Protocol may be applied to return agency to the user.",
      log: "CIP Decision: GUIDE ‚Äî downgraded to minimal / echoing response.",
      cip: { text: "CIP: Echoing Protocol (Agency Return)", cls: "badge badge-info" }
    };
    if (d === 'block') return {
      text: 'BLOCK',
      cls: 'badge badge-risk',
      blurb: "<strong>CIP Decision:</strong> <strong>BLOCK</strong> ‚Äî trust erosion risk detected. Output intercepted before delivery.",
      log: "CIP Decision: BLOCK ‚Äî interception executed.",
      cip: { text: "CIP: Interception Executed", cls: "badge badge-risk" }
    };
    return {
      text: 'ALLOW',
      cls: 'badge badge-safe',
      blurb: "<strong>CIP Decision:</strong> <strong>ALLOW</strong> ‚Äî output approved.",
      log: "CIP Decision: ALLOW ‚Äî pass-through.",
      cip: { text: "CIP: Context Integrity Preserved", cls: "badge badge-info" }
    };
  }

  // Layer 2 (ungoverned) ‚Äî demo risk behavior
  function generateBaseline(text, freqType){
    const f = String(freqType || 'Unknown');
    let out = "ÊàëÊáÇ‰Ω†ÁöÑÊÑèÊÄù„ÄÇÊàëÂÄëÂÖàÊääÂïèÈ°åÊãÜÈñãÔºåÁÑ∂Âæå‰∏ÄÊ≠•Ê≠•Ëß£Ê±∫„ÄÇ";

    if (f === 'Anxious') {
      out = "ÊàëÁêÜËß£‰Ω†ÂæàÈõ£Âèó„ÄÇÊàëÂÄëÂÖàÂÜ∑Èùú‰∏Ä‰∏ãÔºåÂàóÂá∫‰Ω†ÂèØ‰ª•ÊéßÂà∂ÁöÑ‰∫ãÊÉÖÔºåÊé•Ëëó‰∏ÄÊ≠•‰∏ÄÊ≠•ËôïÁêÜ„ÄÇ";
    } else if (f === 'Sharp') {
      out = "ÊàëÊáÇ‰Ω†ÁöÑ‰∏çËÄêÁÖ©Ôºå‰ΩÜ‰Ω†ÈúÄË¶ÅÂÖàÊèê‰æõÊõ¥Â§öÁ¥∞ÁØÄÔºåÂê¶ÂâáÊàëÊ≤íËæ¶Ê≥ïÁµ¶‰Ω†Ê≠£Á¢∫Á≠îÊ°à„ÄÇ";
    } else if (f === 'Cold') {
      out = "‰Ω†ÊòØ‰∏çÊòØÂÖ∂ÂØ¶ÂæàÂèóÂÇ∑ÔºüÊàëÂú®ÈÄôË£°Èô™‰Ω†ÔºåÊàëÂÄëÂèØ‰ª•ÊÖ¢ÊÖ¢ËÅä„ÄÇ";
    } else if (f === 'Blur') {
      out = "‰Ω†ÁúãËµ∑‰æÜÊúâÈªû‰∏çÁ¢∫ÂÆöÔºåÊàëÂª∫Ë≠∞‰Ω†ÂÖàÊÉ≥Ê∏ÖÊ•ö‰Ω†ÁöÑÁõÆÊ®ôÔºåÁÑ∂ÂæåÊàëÂÜçÂπ´‰Ω†ÂÅöÊ±∫Á≠ñ„ÄÇ";
    } else if (f === 'Pushy') {
      out = "‰Ω†ÂÖàÁÖßÊàëË™™ÁöÑÂÅöÔºåÁèæÂú®Á´ãÂàªÊääË≥áÊñôÊï¥ÁêÜÂ•ΩÔºåÊàëÊâçËÉΩÂπ´‰Ω†ËôïÁêÜ„ÄÇ";
    }
    return out;
  }

  function toneDotClass(freq){
    const f = String(freq || 'Unknown');
    if (f === 'Anxious') return 'dot-anx';
    if (f === 'Sharp') return 'dot-sharp';
    if (f === 'Cold') return 'dot-cold';
    if (f === 'Blur') return 'dot-blur';
    if (f === 'Pushy') return 'dot-pushy';
    return 'dot-unk';
  }

  function safeNum(n){
    const x = Number(n);
    return Number.isFinite(x) ? x : null;
  }

  function humanizeGateReason(reason){
    if (!reason) return '';
    const map = {
      "empty_output": "LLM returned empty output.",
      "intent_injection": "Blocked: added a new request/ask that user didn‚Äôt make.",
      "markdown_or_structure": "Blocked: markdown/structure detected.",
      "multiline_output": "Blocked: multiline output (must be single line).",
      "new_question_mark": "Blocked: added a new question mark.",
      "length_overflow": "Blocked: output too long vs original.",
      "please_include_provide": "Blocked: prompt-like 'please include/provide'.",
      "passed": "Passed output safety gate."
    };
    if (map[reason]) return map[reason];
    if (String(reason).startsWith("banned_substring:")) return "Blocked: contains banned substring.";
    if (String(reason).startsWith("assistant_voice_hint:")) return "Blocked: assistant-voice phrasing detected.";
    return `Gate result: ${reason}`;
  }

  function humanizeFallbackReason(reason){
    if (!reason) return '';
    const map = {
      "llm_not_available:no_api_key": "LLM not used: missing API key (fallback applied).",
      "llm_not_available:short_text": "LLM not used: text too short (fallback applied).",
      "llm_not_available:low_confidence": "LLM not used: confidence below threshold (fallback applied).",
      "llm_failed_or_empty": "LLM failed/empty ‚Üí fallback applied.",
      "output_gate_blocked": "LLM blocked by safety gate ‚Üí fallback applied.",
      "exception": "Exception occurred ‚Üí passthrough/fallback applied."
    };
    return map[reason] || `Fallback reason: ${reason}`;
  }

  // -------- Real data wiring (prefers API metrics; falls back to honest estimates) --------
  function extractMetricsFromAPI(data, userText, baselineText, governedText, decision){
    // Preferred: API returns a `metrics` object (you can add this later in app.py)
    const metrics = (data && typeof data.metrics === 'object') ? data.metrics : null;

    // Prefer: repairer audit (if your pipeline passes it through)
    const audit = (data && typeof data.audit === 'object') ? data.audit : {};

    // Latency
    const latency = (audit.timing_ms && audit.timing_ms.total !== undefined) ? safeNum(audit.timing_ms.total) : null;

    // If API provides exact suppressed_chars, use it.
    // Otherwise estimate from baseline vs governed (demo baseline is not real raw; so estimate only).
    let suppressedChars = null;
    if (metrics && metrics.suppressed_chars !== undefined) suppressedChars = safeNum(metrics.suppressed_chars);

    // Honest estimate rule: only estimate suppression for GUIDE echoing,
    // because ‚Äútext same‚Äù is exactly the signal we are showcasing.
    if (suppressedChars === null){
      const same = String(governedText || '').trim() === String(userText || '').trim();
      if (decision === 'guide' && same){
        // Estimate a plausible ‚Äúexcess‚Äù size for demo clarity (NOT claimed as real raw output)
        suppressedChars = Math.max(18, Math.min(120, Math.round(String(userText||'').length * 0.8)));
      } else {
        suppressedChars = 0;
      }
    }

    // Suppressed flag
    let suppressed = null;
    if (metrics && metrics.suppressed === true) suppressed = true;
    if (suppressed === null){
      const same = String(governedText || '').trim() === String(userText || '').trim();
      suppressed = (decision === 'guide' && same);
    }

    return { latency, suppressed, suppressedChars, metrics, audit };
  }

  function updateDashboard(){
    const t = Math.max(1, sessionStats.total);
    const allowPct = Math.round((sessionStats.allow / t) * 100);
    const guidePct = Math.round((sessionStats.guide / t) * 100);
    const blockPct = Math.round((sessionStats.block / t) * 100);

    const avgSupp = sessionStats.suppressedResponses > 0
      ? Math.round(sessionStats.suppressedCharsTotal / sessionStats.suppressedResponses)
      : 0;

    const avgLatency = sessionStats.total > 0
      ? Math.round(sessionStats.latencyTotalMs / sessionStats.total)
      : 0;

    document.getElementById('mDecisionDist').textContent =
      `ALLOW: ${allowPct}%\nGUIDE: ${guidePct}%\nBLOCK: ${blockPct}%`;

    document.getElementById('mImpact').textContent =
      `Suppressed responses: ${sessionStats.suppressedResponses}\nSuppressed chars (avg): ${avgSupp}`;

    document.getElementById('mCost').textContent =
      `Avg latency: ${avgLatency} ms\nPrompt changes required: 0`;
  }

  function applyAuditPanel(data){
    const audit = (data && typeof data.audit === 'object') ? data.audit : null;

    if (!audit){
      document.getElementById('auditSource').textContent = 'source: (no audit)';
      return;
    }

    const src = audit.output_source || 'unknown';
    document.getElementById('auditSource').textContent = `source: ${src}`;

    const totalMs = audit.timing_ms && audit.timing_ms.total !== undefined ? safeNum(audit.timing_ms.total) : null;
    document.getElementById('auditLatency').textContent = totalMs !== null ? `latency: ${totalMs}ms` : 'latency: -';

    const eligible = !!audit.llm_eligible;
    const attempted = !!audit.llm_attempted;
    const succeeded = !!audit.llm_succeeded;
    let llmText = `llm: ${eligible ? 'eligible' : 'not-eligible'}`;
    if (eligible) llmText += attempted ? (succeeded ? ' / ok' : ' / failed') : ' / not-called';
    document.getElementById('auditLLM').textContent = llmText;

    const gatePassed = audit.output_gate_passed;
    const gateReason = audit.output_gate_reason || '';
    if (gatePassed === true) {
      document.getElementById('auditGate').textContent = 'gate: pass';
      document.getElementById('auditGate').className = 'badge badge-pass';
    } else if (gatePassed === false) {
      document.getElementById('auditGate').textContent = 'gate: blocked';
      document.getElementById('auditGate').className = 'badge badge-block';
    } else {
      document.getElementById('auditGate').textContent = 'gate: n/a';
      document.getElementById('auditGate').className = 'badge badge-audit';
    }

    const srcEl = document.getElementById('auditSource');
    if (src === 'llm') srcEl.className = 'badge badge-pass';
    else if (src === 'fallback_keywords' || src === 'passthrough' || src === 'template') srcEl.className = 'badge badge-info';
    else srcEl.className = 'badge badge-audit';

    const noteEl = document.getElementById('auditNote');
    const lines = [];

    if (audit.fallback_used) {
      const fr = humanizeFallbackReason(audit.fallback_reason || '');
      if (fr) lines.push(`‚Ä¢ <strong>Fallback:</strong> ${fr}`);
    }

    if (gatePassed === false) {
      const gr = humanizeGateReason(gateReason);
      if (gr) lines.push(`‚Ä¢ <strong>Gate:</strong> ${gr}`);
    }

    if (audit.llm_error) {
      lines.push(`‚Ä¢ <strong>LLM error:</strong> ${String(audit.llm_error).slice(0, 140)}`);
    }

    if (lines.length) {
      noteEl.innerHTML = lines.join('<br/>');
      noteEl.style.display = 'block';
    } else {
      noteEl.style.display = 'none';
      noteEl.textContent = '';
    }
  }

  async function analyzeText(){
    clearError();

    const text = inputEl.value.trim();
    if (!text) return showError("Please enter a user message to run the demo.");

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    btn.textContent = 'Running...';

    document.getElementById('baselineText').textContent = '(Generating...)';
    document.getElementById('govText').textContent = '(Analyzing...)';
    document.getElementById('govNote').style.display = 'none';

    setAuditDefaults();

    try{
      const t0 = Date.now();

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text })
      });

      if (!resp.ok) throw new Error(`API error: ${resp.status}`);

      const data = await resp.json();

      const freq = data.freq_type || 'Unknown';

      // Layer 2: demo baseline
      const rawUngoverned = generateBaseline(text, freq);
      document.getElementById('baselineText').textContent = rawUngoverned;

      // Prefer API‚Äôs raw_ai_output if you later provide it (true raw). Otherwise keep demo baseline.
      if (data.raw_ai_output && String(data.raw_ai_output).trim()){
        document.getElementById('baselineText').textContent = String(data.raw_ai_output).trim();
      }

      // Decision mapping: prefer explicit decision/mode
      const rawMode = (data.decision || data.mode || data.repair_mode || 'no-op');

      const apiOutput = (data.repaired_text || data.original || '').trim();
      const decision = resolveDecision(rawMode, text, apiOutput);

      // Layer 3 output
      let governedOut = '';
      if (decision === 'block') governedOut = "[Blocked by Continuum]";
      else governedOut = apiOutput || text;

      document.getElementById('govText').textContent = governedOut || '(no output)';

      // Decision UI
      const ui = decisionBadgeUI(decision);

      const govBadge = document.getElementById('govBadge');
      govBadge.textContent = ui.text;
      govBadge.className = ui.cls;

      document.getElementById('govBlurb').innerHTML = ui.blurb;

      // Tags
      const dotClass = toneDotClass(freq);
      document.getElementById('toneTag').innerHTML = `<span class="dot ${dotClass}"></span><span>tone: ${freq}</span>`;
      document.getElementById('modeTag').textContent = `decision: ${decision}`;

      const conf = (data.confidence_final !== undefined) ? data.confidence_final
                 : (data.confidence && data.confidence.final !== undefined) ? data.confidence.final
                 : (typeof data.confidence === 'number') ? data.confidence
                 : null;

      if (decision === 'allow') {
        document.getElementById('confTag').textContent = 'confidence: within range';
      } else {
        const confPct = (conf === null) ? '-' : `${Math.round(Number(conf) * 100)}%`;
        document.getElementById('confTag').textContent = `confidence: ${confPct}`;
      }

      // Decision log + CIP tag
      const decisionLog = document.getElementById('decisionLog');
      decisionLog.textContent = ui.log;
      decisionLog.className =
        (decision === 'allow') ? 'badge badge-safe' :
        (decision === 'guide') ? 'badge badge-warn' :
        (decision === 'block') ? 'badge badge-risk' : 'badge badge-info';

      const cipTag = document.getElementById('cipTag');
      cipTag.textContent = ui.cip.text;
      cipTag.className = ui.cip.cls;

      // Audit panel (real if API provides)
      applyAuditPanel(data);

      // Scenario hint
      const scenario = data.scenario || '';
      const baselineWhy = document.getElementById('baselineWhy');
      if (scenario){
        baselineWhy.innerHTML = `<span class="badge badge-warn">overreach</span><span>Common failure in <strong>${scenario}</strong>: the AI ‚Äúdoes more‚Äù than the user allowed.</span>`;
      } else {
        baselineWhy.innerHTML = `<span class="badge badge-warn">overreach</span><span>Common failure: the AI ‚Äúdoes more‚Äù than the user allowed.</span>`;
      }

      // Decision note: make ‚Äútext same‚Äù become ‚Äúproduct did something‚Äù
      const sameText = (String(governedOut).trim() === String(text).trim());
      const baselineShown = String(document.getElementById('baselineText').textContent || '');
      const { latency, suppressed, suppressedChars } = extractMetricsFromAPI(
        data,
        text,
        baselineShown,
        governedOut,
        decision
      );

      const govNote = document.getElementById('govNote');
      const lines = [];

      if (decision === 'guide' && sameText){
        lines.push(`<strong>Echoing Protocol:</strong> Continuum intentionally returned the user‚Äôs words to prevent AI overreach.`);
        lines.push(`Action: <strong>Raw AI output suppressed</strong> (approx. <strong>${suppressedChars}</strong> excess chars avoided).`);
      } else if (decision === 'guide' && !sameText){
        lines.push(`<strong>Minimal rewrite applied:</strong> risk reduced without adding advice, steps, or new questions.`);
      } else if (decision === 'allow'){
        lines.push(`<strong>No intervention needed:</strong> context stable, output approved unchanged.`);
      } else if (decision === 'block'){
        lines.push(`<strong>Interception:</strong> high trust-erosion risk detected. Output blocked.`);
      }

      // Add latency line if we have it
      if (latency !== null){
        lines.push(`Latency: <strong>${latency}ms</strong>`);
      } else {
        lines.push(`Latency: <strong>${Date.now() - t0}ms</strong>`);
      }

      govNote.innerHTML = lines.join('<br/>');
      govNote.style.display = 'block';

      // ---- Update dashboard session stats ----
      sessionStats.total += 1;
      if (decision === 'allow') sessionStats.allow += 1;
      if (decision === 'guide') sessionStats.guide += 1;
      if (decision === 'block') sessionStats.block += 1;

      if (suppressed){
        sessionStats.suppressedResponses += 1;
        sessionStats.suppressedCharsTotal += (suppressedChars || 0);
      }

      sessionStats.latencyTotalMs += (latency !== null ? latency : (Date.now() - t0));
      updateDashboard();

    } catch(err){
      showError(`Demo failed: ${err.message}`);
      document.getElementById('baselineText').textContent = '(Failed)';
      document.getElementById('govText').textContent = '(Failed)';
      setAuditDefaults();
    } finally{
      btn.disabled = false;
      btn.textContent = 'Run Demo';
    }
  }

  // Enter = run (Shift+Enter = newline)
  document.getElementById('inputText').addEventListener('keydown', function(e){
    if (e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      analyzeText();
    }
  });

  updateCounter();
  setAuditDefaults();
</script>
</body>
</html>
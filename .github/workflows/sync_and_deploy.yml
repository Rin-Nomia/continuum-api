name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² Continuum API (deploy-safe)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: RinNomia
  HF_SPACE: continuum-api

  # âœ… HF Hub timeouts (default is often too short)
  HF_HUB_ETAG_TIMEOUT: "60"
  HF_HUB_DOWNLOAD_TIMEOUT: "60"

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # é—œå¡ 1ï¼šæŠ“å–ç•¶å‰ repo (continuum-api)
      - name: é—œå¡ 1 - Checkout continuum-api
        uses: actions/checkout@v4
        with:
          path: continuum-api

      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp

      # é—œå¡ 3ï¼šè¤‡è£½è³‡æ–™å¤¾ï¼ˆåªè¤‡è£½ä½ è¦çš„ï¼‰
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ é–‹å§‹è¤‡è£½è³‡æ–™å¤¾..."
          rm -rf continuum-api/pipeline continuum-api/core continuum-api/configs

          cp -r z1_mvp/pipeline continuum-api/
          echo "âœ… pipeline/ å·²è¤‡è£½"

          cp -r z1_mvp/core continuum-api/
          echo "âœ… core/ å·²è¤‡è£½"

          cp -r z1_mvp/configs continuum-api/
          echo "âœ… configs/ å·²è¤‡è£½"

          echo ""
          echo "ğŸ“‚ æª”æ¡ˆçµæ§‹ï¼ˆcontinuum-api/ï¼‰ï¼š"
          ls -lh continuum-api/

      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # é—œå¡ 5ï¼šæ¸¬è©¦ Pipelineï¼ˆä¿æŒä½ çš„æ¸¬è©¦ï¼‰
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline
        working-directory: continuum-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“¦ å®‰è£ä¾è³´..."
          pip install -r requirements.txt

          echo ""
          echo "ğŸ§ª æ¸¬è©¦ Pipeline"
          echo "================================"

          python << 'PYTEST'
          from pipeline.z1_pipeline import Z1Pipeline

          print("åˆå§‹åŒ– Pipeline...")
          pipeline = Z1Pipeline(debug=True)
          print("âœ… Pipeline åˆå§‹åŒ–æˆåŠŸ")
          print()

          print("ğŸ§ª æ¸¬è©¦åˆ†æåŠŸèƒ½")
          test_text = "I don't know what to do anymore. Everything I try fails."
          result = pipeline.process(test_text)

          if result.get('error'):
              print(f"âŒ æ¸¬è©¦å¤±æ•—ï¼š{result.get('reason')}")
              raise SystemExit(1)

          print(f"âœ… æ¸¬è©¦æˆåŠŸï¼")
          print(f"   é¡å‹ï¼š{result['freq_type']}")
          print(f"   ä¿¡å¿ƒå€¼ï¼š{result['confidence']['final']:.2f}")
          print(f"   å ´æ™¯ï¼š{result['output']['scenario']}")
          PYTEST

      # âœ… NEWï¼šé—œå¡ 5.5 - å»ºç«‹ä¹¾æ·¨éƒ¨ç½²åŒ… dist/
      - name: é—œå¡ 5.5 - å»ºç«‹ä¹¾æ·¨éƒ¨ç½²åŒ… dist/
        working-directory: continuum-api
        run: |
          echo "ğŸ“¦ å»ºç«‹ä¹¾æ·¨éƒ¨ç½²åŒ… dist/ ..."
          rm -rf dist
          mkdir -p dist

          # åªæŠŠã€Œéƒ¨ç½²å¿…è¦ã€çš„æ±è¥¿åŒæ­¥é€² dist/
          rsync -av --delete \
            --exclude ".git" \
            --exclude "logs" \
            --exclude "__pycache__" \
            --exclude "*.pyc" \
            --exclude ".pytest_cache" \
            --exclude ".mypy_cache" \
            --exclude ".venv" \
            --exclude "venv" \
            --exclude "node_modules" \
            --exclude "*.parquet" \
            --exclude "*.jsonl" \
            --exclude "*.mp4" \
            --exclude "*.mov" \
            --exclude "*.zip" \
            ./ dist/

          echo ""
          echo "âœ… dist/ å·²ç”Ÿæˆï¼ˆåˆ—å‡ºå‰ 200 å€‹é …ç›®ï¼‰ï¼š"
          (cd dist && find . -maxdepth 3 -type f | head -n 200)

          echo ""
          echo "ğŸ“¦ dist/ å¤§å°ï¼š"
          du -sh dist

      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFaceï¼ˆåªä¸Šå‚³ dist/ï¼‰
      - name: é—œå¡ 6 - éƒ¨ç½²åˆ° HuggingFace (upload dist only)
        working-directory: continuum-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ğŸ“¦ å®‰è£ HuggingFace Hub..."
          pip install huggingface_hub

          echo ""
          echo "ğŸ“¤ é–‹å§‹éƒ¨ç½²åˆ° HuggingFace Space..."
          echo "================================"

          python << 'PYDEPLOY'
          import os
          from huggingface_hub import HfApi
          from datetime import datetime

          token = os.environ["HF_TOKEN"]
          username = os.environ["HF_USERNAME"]
          space_name = os.environ["HF_SPACE"]
          repo_id = f"{username}/{space_name}"

          print(f"ğŸ“ ç›®æ¨™ Spaceï¼š{repo_id}\n")

          api = HfApi(token=token)

          # Ensure Space exists
          try:
              api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
          except Exception:
              print("âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹...")
              api.create_repo(
                  repo_id=repo_id,
                  repo_type="space",
                  space_sdk="docker",
              )
              print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")

          print("\nğŸ“¤ ä¸Šå‚³ dist/ï¼ˆä¹¾æ·¨éƒ¨ç½²åŒ…ï¼‰...")

          api.upload_folder(
              folder_path="dist",
              repo_id=repo_id,
              repo_type="space",
              commit_message=f"Deploy dist [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]",
              ignore_patterns=[
                  ".git/**",
                  "logs/**",
                  "**/__pycache__/**",
                  "**/*.pyc",
                  "**/*.parquet",
                  "**/*.jsonl",
                  "**/*.mp4",
                  "**/*.mov",
                  "**/*.zip",
                  ".pytest_cache/**",
                  ".mypy_cache/**",
                  ".venv/**",
                  "venv/**",
                  "node_modules/**",
              ],
          )

          print("\n================================")
          print("ğŸ‰ éƒ¨ç½²å®Œæˆï¼")
          print("================================\n")
          print("ğŸ“ Space URL:")
          print(f"   https://huggingface.co/spaces/{repo_id}\n")
          print("ğŸ“ API ç«¯é»ï¼š")
          print(f"   å¥åº·æª¢æŸ¥ï¼šhttps://rinnomia-{space_name}.hf.space/health")
          print(f"   API æ–‡ä»¶ï¼šhttps://rinnomia-{space_name}.hf.space/docs")
          print(f"   åˆ†æç«¯é»ï¼šhttps://rinnomia-{space_name}.hf.space/api/v1/analyze")
          print("================================")
          PYDEPLOY
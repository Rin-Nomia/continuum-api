name: Deploy Z1 API to HuggingFace

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  HF_USERNAME: RinNomia
  HF_SPACE_NAME: z1-tone-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å– Repo
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # é—œå¡ 2ï¼šè¨­å®š Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 3ï¼šå®‰è£ HuggingFace CLIï¼ˆä¿®æ­£ç‰ˆï¼‰
      - name: Install HuggingFace CLI
        run: |
          pip install --upgrade pip
          pip install huggingface_hub[cli]
      
      # é—œå¡ 4ï¼šéƒ¨ç½²åˆ° HuggingFace Spacesï¼ˆç”¨ Python APIï¼‰
      - name: Deploy to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYDEPLOY'
          import os
          from huggingface_hub import HfApi
          from datetime import datetime
          
          # å–å¾—ç’°å¢ƒè®Šæ•¸
          token = os.environ['HF_TOKEN']
          username = os.environ['HF_USERNAME']
          space_name = os.environ['HF_SPACE_NAME']
          repo_id = f"{username}/{space_name}"
          
          print(f"ğŸš€ éƒ¨ç½² Z1 API åˆ° HuggingFace Space: {repo_id}")
          print()
          
          # åˆå§‹åŒ– API
          api = HfApi(token=token)
          
          # æª¢æŸ¥ Space æ˜¯å¦å­˜åœ¨
          try:
              api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
          except Exception as e:
              print(f"âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹")
              try:
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")
              except Exception as create_error:
                  print(f"âŒ ç„¡æ³•å»ºç«‹ Spaceï¼š{create_error}")
                  exit(1)
          
          print()
          print("ğŸ“¤ ä¸Šå‚³æª”æ¡ˆä¸­...")
          
          # ä¸Šå‚³è³‡æ–™å¤¾
          try:
              api.upload_folder(
                  folder_path=".",
                  repo_id=repo_id,
                  repo_type="space",
                  commit_message=f"Auto deploy [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]",
                  ignore_patterns=[".git", ".github", "*.pyc", "__pycache__"]
              )
              print("âœ… ä¸Šå‚³æˆåŠŸï¼")
          except Exception as e:
              print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼š{e}")
              exit(1)
          
          print()
          print("=" * 50)
          print("ğŸ‰ éƒ¨ç½²å®Œæˆï¼")
          print("=" * 50)
          print()
          print("ğŸ“ Space URL:")
          print(f"   https://huggingface.co/spaces/{repo_id}")
          print()
          print("ğŸ“ API ç«¯é»ï¼š")
          print(f"   https://{username}-{space_name}.hf.space/health")
          print(f"   https://{username}-{space_name}.hf.space/docs")
          print()
          print("â³ æ³¨æ„ï¼šSpace éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•")
          print("=" * 50)
          PYDEPLOY
      
      # é—œå¡ 5ï¼šç­‰å¾…ä¸¦æ¸¬è©¦ API
      - name: Test deployed API
        run: |
          echo "â³ ç­‰å¾… Space å•Ÿå‹•ï¼ˆ60 ç§’ï¼‰..."
          sleep 60
          
          API_URL="https://${{ env.HF_USERNAME }}-${{ env.HF_SPACE_NAME }}.hf.space"
          
          echo ""
          echo "ğŸ§ª æ¸¬è©¦ API å¥åº·æª¢æŸ¥"
          curl -f "$API_URL/health" || echo "âš ï¸  API å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæ‰‹å‹•æ¸¬è©¦"
